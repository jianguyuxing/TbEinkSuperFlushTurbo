# TbEinkSuperFlushTurbo - 电子墨水屏残影清除工具

<div align="right">
  <strong>语言:</strong> 中文 | <a href="README_EN.md">English</a>
</div>

## 项目简介

TbEinkSuperFlushTurbo 是一款专为电子墨水屏设备设计的智能残影清除工具。通过DirectX GPU加速和智能区域检测算法，有效减少屏幕残影和闪烁，提供更佳的视觉体验。

⚠️ **重要说明**：目前版本仅支持主显示器的分辨率和DPI准确检测，请将您的电子墨水屏设备设置为主显示器以获得最佳效果。

### 🖥️ 主要目标设备
**本工具主要针对 ThinkBook Plus Gen4 (Twist) 的 Kaleido 彩色电子墨水屏开发和优化测试**，同时兼容其他电子墨水屏设备。

## 核心功能

### 🎯 智能残影清除
- **GPU加速处理**：利用DirectX 11和计算着色器进行高性能图像处理
- **图块化检测**：将屏幕划分为8x8像素图块，精确检测变化区域
- **智能刷新算法**：基于多帧稳定性检测，避免过度刷新

### 💡 工作原理
- **非波形驱动技术**：采用当前稳定区域的反向半透明亮度颜色（黑色/白色）作为刷新色，短暂停留100ms，驱动电子墨水屏快速扰动墨水粒子，实现残影清除效果
- **局部刷新优势**：使用局部刷新而非全屏刷新，减少屏幕闪烁
- **单次反色刷新**：反色刷新仅闪烁一次，相比系统驱动的4次闪动（黑→白→黑→白）大幅减少干扰

### 🚀 Turbo功能
- **GPU并行计算**：每个区块的像素差异对比以及对区块的遍历操作均放到GPU中进行，极大减少全屏计算数百万像素带来的性能影响
- **滚动区域抑制刷新**：在小区块的基础上，增加固定划分相邻区块的合围区域。对于合围区域内m帧中有n帧需要刷新的区域（认为是发生了滚动），区域内的区块不进行刷新。滚动停止后会进行刷新，极大减少了滚动时文字上短暂显示反色带来的干扰

### 🚫 智能区域过滤
- **光标区域排除**：自动排除鼠标和文本光标周围区域（3个图块半径）
  - ⚠️ **限制说明**：仅支持标准Windows文本光标API，对于使用非标准光标API绘制的第三方应用光标可能无法检测

### ⚡ 性能优化
- **首次刷新延迟机制**：为了避免启动时因大量区域变化导致的全屏刷新，首次触发刷新会有适当延迟，确保只对真正需要刷新的区域进行处理
- **冷却期机制**：已刷新的区块会在短时间内进入冷却期，防止重复刷新，进一步降低屏幕闪烁和提高用户体验
- **用户全刷智能识别**：95%区域变化时视为用户手动/自动使用电脑原有EINK驱动进行了全刷，此时重置变化统计，避免引起重复全屏刷新
- **最小化干扰**：仅刷新必要区域，减少屏幕闪烁

### 🎨 可视化反馈
- **实时覆盖层**：刷新区域显示短暂的颜色覆盖（100ms）
- **托盘图标**：支持最小化到系统托盘
- **详细日志**：完整的操作日志和性能统计

## 技术特点

### 亮度差异检测算法
本项目采用了基于GPU的亮度差异检测算法，通过DirectX 11计算着色器进行高效的屏幕内容分析：

1. **图块化处理**：将整个屏幕划分为8x8像素的图块，便于并行处理和局部刷新
2. **像素级比较**：对每个图块内的像素进行前后帧对比，计算RGB三通道差值
3. **亮度计算**：使用标准亮度公式 Y = 0.299×R + 0.587×G + 0.114×B 计算每个像素的亮度
4. **平均差异阈值**：设定像素差异阈值，超过阈值的变化才会被认为是显著变化
5. **滑动窗口平均**：采用4帧滑动窗口平均算法，平滑瞬时变化，提高检测稳定性
6. **多帧稳定性检测**：只有连续3帧以上稳定的区域才会触发刷新操作
7. **动态冷却期**：根据覆盖层显示时间动态计算冷却期，确保刷新过的区块在冷却期内不会重复刷新
8. **噪声过滤**：智能识别和过滤屏幕噪声

该算法充分利用GPU并行计算能力，在保证检测精度的同时实现了极高的处理效率。

### DirectX集成
- **Vortice.DirectX**：使用现代.NET DirectX包装器
- **计算着色器**：GPU并行处理图像数据
- **高性能捕获**：低延迟屏幕捕获和处理

### 系统兼容性
- **高DPI支持**：自动适配不同DPI缩放设置
- **多架构支持**：支持x64架构
- **Windows 10/11**：专为现代Windows系统优化
- **智能屏幕识别**：自动检测屏幕刷新率、DPI缩放比例，支持多显示器环境
- **E-ink屏自动识别**：通过刷新率特征（小于55Hz）智能识别电子墨水屏设备

## 使用方法

### 基本操作
1. 运行 `TbEinkSuperFlushTurbo.exe`
2. 点击 **Start** 按钮开始监控
3. 点击 **Stop** 按钮停止监控
4. 使用托盘图标控制显示/隐藏

### 高级设置
- 支持命令行参数配置
- 可自定义检测参数（图块大小、阈值等）
- 支持日志级别调整

### 配置文件说明

应用程序使用一个配置文件，存储在应用程序目录中：

1. `config.json` - 包含所有应用程序设置：
   ```json
   {
     "PixelDelta": 10,
     "PollInterval": 500,
     "TileSize": 8,
     "ScreenIndex": 0,
     "ToggleHotkey": 117
   }
   ```
   参数说明：
   - `PixelDelta`：像素颜色差异敏感度阈值（2-25）
   - `PollInterval`：屏幕捕获间隔（毫秒）（200-5000）
   - `TileSize`：检测区块大小（像素）（8-64）
   - `ScreenIndex`：多显示器设置中的目标显示器索引（0为主显示器）
   - `ToggleHotkey`：切换快捷键的虚拟键码（117 = F6）

如果此文件不存在，应用程序会在首次运行时创建带有默认值的配置文件。

## 系统要求

- **操作系统**：Windows 10 或更高版本
- **.NET版本**：.NET 8.0 或更高版本
- **显卡**：支持DirectX 11的显卡
- **权限**：建议以管理员权限运行以获得最佳效果
- **推荐设备**：ThinkBook Plus Gen4 (Twist) 或其他配备Kaleido电子墨水屏的设备

## 构建说明

### 开发环境
- Visual Studio 2022 或更高版本
- .NET 8.0 SDK
- Windows 10 SDK

### 依赖库
- Vortice.Direct3D11 (3.6.2)
- Vortice.DXGI (3.6.2)
- Vortice.D3DCompiler (3.6.2)

### 编译步骤
```bash
# 克隆项目
git clone [项目地址]

# 进入项目目录
cd TbEinkSuperFlushTurbo

# 还原依赖
dotnet restore

# 编译项目
dotnet build

# 运行项目
dotnet run
```

## 性能表现

### 检测性能
- **检测周期**：515ms（可配置）
- **处理延迟**：< 50ms
- **内存占用**：< 100MB

### 刷新优化
- **减少刷新次数**：相比传统方法减少60-80%
- **降低闪烁**：智能保护期机制
- **延长屏幕寿命**：最小化不必要的刷新操作

## 故障排除

### ⚙️ 自动检测功能

#### 屏幕检测机制

- **刷新率检测**：自动扫描所有连接的显示器，识别刷新率特征
- **E-ink屏识别**：通过低刷新率（小于55Hz）智能识别电子墨水屏设备
- **多显示器支持**：在多屏环境中自动选择E-ink屏进行处理
- **DPI自适应**：自动检测并适配不同DPI缩放设置

#### 检测逻辑

1. **系统枚举**：通过Windows API枚举所有显示器信息
2. **特征识别**：基于刷新率、分辨率等特征识别E-ink屏
3. **优先级处理**：优先处理识别到的E-ink屏，支持多E-ink屏环境
4. **动态适应**：显示器连接状态变化时自动重新检测

### 故障排除
1. **程序无法启动**：检查是否安装.NET 8.0运行时
2. **DirectX初始化失败**：更新显卡驱动程序
3. **检测不准确**：调整DPI设置或检测参数
4. **光标检测失败**：某些第三方应用使用非标准光标API，无法被检测
5. **显示效果不佳**：使用浅色主题+英特尔显卡中心调节过对比度增强使得界面为纯白色时效果最好，或者是使用白底高对比度主题

### ⚠️ 特别提示
- **系统功能干扰**：省电模式、夜间模式以及以下两个系统亮度选项（默认开启，对电子墨水屏同样生效）可能会影响显示效果：
  - "根据内容自动调节亮度"
  - "根据光线自动调节亮度"
- **显示效果说明**：上述功能会在浅色界面上产生灰色小波浪线，程序清除残影后显示的纯白色可能会与这些灰色界面形成对比，看起来像是白色残影

### 调试信息
- 查看 `Logs` 目录下的详细日志文件
- 检查 `debug_output.txt` 获取调试信息
- 使用Visual Studio调试器进行深度分析

## 更新日志

### 最新版本
- ✅ GPU加速图像处理
- ✅ 智能区域过滤
- ✅ 高DPI支持
- ✅ 托盘图标功能
- ✅ 详细日志系统

## 贡献指南

欢迎提交Issue和Pull Request来改进项目。在贡献前请：
1. 阅读项目文档和代码注释
2. 在本地测试所有更改
3. 遵循现有代码风格

## 许可证

本项目采用开源许可证，详见LICENSE文件。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交GitHub Issue
- 发送详细的问题描述和日志文件

---

**注意**：本工具专为电子墨水屏设备优化，在普通LCD/LED屏幕上可能看不到明显效果。建议在使用前关闭其他屏幕刷新工具以避免冲突。